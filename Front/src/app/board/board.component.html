<div class="game-background">
    <div class="legend-panel">
        <div class="legend-title">ğŸ§™ Historia:</div>
        <div class="legend-text">
            Despiertas en un bosque donde cada hoja muestra fragmentos de cÃ³digo. Un Ã¡rbol-antiguo llamado <b>RootNode</b> te habla con voz crÃ­ptica:<br><br>
            <i>â€œPara salir de este entorno, encuentra las palabras que alguna vez me compilaron.â€</i>
            <hr>
            <b>Â¿CÃ³mo te mueves?</b><br> Usa los botones para mover el coche por el tablero. Encadena movimientos y presiona "Enviar" para avanzar varios pasos de una vez.
            <hr>
            <b>Â¿CÃ³mo pasas de nivel?</b><br> Encuentra todas las respuestas a las preguntas que aparecen en la parte derecha del tablero. Cada respuesta es una palabra clave que desbloquea el siguiente nivel.
            <hr>
            <b>Â¿CÃ³mo pierdes?</b><br> Si el tiempo se agota antes de encontrar todas las respuestas <br> O te quedas sin pasos, el juego termina. Â¡Pero puedes reiniciar y volver a intentarlo!
            <hr>
        </div>
    </div>
    <div class="game-container">
        <h2>Sopa de Letras: EdiciÃ³n DinÃ¡mica</h2>

        <div class="timer" [class.game-over]="isGameOver && timeLeft === 0">
            â° Tiempo restante: {{ timeLeft }}s
        </div>

        <div *ngIf="isGameOver && !showWinMenu && timeLeft === 0" class="game-over-modal">
            <div class="game-over-content">
                <h2>Â¡Game Over!</h2>
                <p>Se acabÃ³ el tiempo.</p>
                <button (click)="resetGame()">Reiniciar</button>
                <a class="home-link" routerLink="/" routerLinkActive="active-link"><button>HOME</button></a>
            </div>
        </div>

        <div *ngIf="showWinMenu" class="game-over-modal">
            <div class="game-over-content">
                <h2>Â¡Felicidades!</h2>
                <p>Â¡Encontraste todas las respuestas!</p>
                <p>Puntaje final: <b>{{ finalScore }}</b></p>
                <button (click)="resetGame()">Jugar de nuevo</button>
                <button (click)="submitScore()">Subir Puntaje</button>
                <a class="home-link" routerLink="/" routerLinkActive="active-link"><button>HOME</button></a>
            </div>
        </div>

        <div class="game-layout" [class.mobile-layout]="isMobileDevice" [class.desktop-layout]="!isMobileDevice">
            <div class="board" *ngIf="board.length > 0">
                <div class="row" *ngFor="let row of board; let i = index">
                    <app-cell *ngFor="let cell of row; let j = index" [value]="cell" [isCarPosition]="isCarPosition(i, j)" [isFound]="isPositionFound(i, j)" [foundColor]="getPositionColor(i, j)">
                    </app-cell>
                </div>
            </div>
            <div *ngIf="board.length === 0 && currentQuestions.length > 0" class="loading-board">
                Cargando tablero...
            </div>
            <div *ngIf="currentQuestions.length === 0" class="no-questions">
                <p>No hay preguntas disponibles para esta dificultad.</p>
                <p>Por favor, ve al <a routerLink="/admin">Panel de Administrador</a> para agregar algunas.</p>
            </div>


            <div class="target-elements" *ngIf="currentQuestions.length > 0">
                <h3>Encuentra las Respuestas a estas Preguntas:</h3>
                <div class="questions-container">
                    <div class="question-item" *ngFor="let question of currentQuestions" [style.border-left-color]="answerColors[question.id]" [class.question-found]="question.isFound">
                        <div class="question-text">
                            <strong>{{ question.question }}</strong>
                        </div>
                        <div class="answer-letters">
                            <span *ngFor="let letter of question.answer.split(''); let i = index" [class.found]="isQuestionLetterFound(question.id, i)" [style.background-color]="isQuestionLetterFound(question.id, i) ? answerColors[question.id] : ''">
              {{ letter }}
            </span>
                        </div>
                        <div class="progress">
                            {{ getQuestionProgress(question.id).found }} de {{ getQuestionProgress(question.id).total }} letras
                        </div>
                    </div>
                    <div class="game-actions">
                        <a class="home-link" routerLink="/" routerLinkActive="active-link"><button>HOME</button></a>
                        <button class="reset-button" type="button" (click)="resetGame()">REINICIAR</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-move-chain" *ngIf="currentQuestions.length > 0">
            <div class="move-buttons">
                <button type="button" class="btn-up" (click)="addMove('up')">â†‘</button>
                <button type="button" class="btn-left" (click)="addMove('left')">â†</button>
                <button type="button" class="btn-right" (click)="addMove('right')">â†’</button>
                <button type="button" class="btn-down" (click)="addMove('down')">â†“</button>
            </div>
            <div class="move-sequence">
                <span *ngIf="moveSequence.length === 0" class="move-placeholder">Selecciona movimientos...</span>
                <ng-container *ngFor="let move of moveSequence; let idx = index">
                    <span class="move-chip" [ngClass]="'move-' + move">
                  {{ move === 'up' ? 'Arriba' : move === 'down' ? 'Abajo' : move === 'left' ? 'Izquierda' : 'Derecha' }}
                </span>
                </ng-container>
                <button *ngIf="moveSequence.length > 0" class="clear-moves" (click)="clearMoveSequence()" title="Limpiar secuencia">âœ•</button>
            </div>
            <button class="send-moves" [disabled]="moveSequence.length === 0" (click)="sendMoveSequence()">Enviar</button>
            <div class="steps-counter">Pasos: {{ steps }}/{{ maxSteps }}</div>
        </div>

        <div class="keyboard-instructions" *ngIf="!isMobileDevice && currentQuestions.length > 0">
            <p>Usa las flechas del teclado para moverte.</p>
        </div>
    </div>
</div>